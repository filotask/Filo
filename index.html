<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FiloTrack - Project Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        /* ... (all your existing CSS styles remain unchanged here) ... */
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4 login-gradient">
        </div>

    <div id="dashboard" class="hidden">
        </div>

    <script>
       // --- SUPABASE SETUP ---
const SUPABASE_URL = 'https://kiltzkbpdanhyrvfcbiv.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtpbHR6a2JwZGFuaHlydmZjYml2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1NjgyNzUsImV4cCI6MjA3MjE0NDI3NX0.-5uNx4506fdgkqyecvM8dLGQ1DhlG-0m1GiLUX3TVcQ';
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);


// --- GLOBAL STATE ---
let currentUser = null; // Will hold profile data + auth email
let allUsers = []; // Will hold all profiles
let projects = [];
let tasks = [];
let messages = [];
let notifications = [];

let sidebarCollapsed = false;
let isDarkMode = JSON.parse(localStorage.getItem('FiloTrack_darkMode')) || false;
let editingUserId = null;
let selectedChatUser = null;


// --- QUOTES (Unchanged from original) ---
const quotes = [
    { text: "In the world of business, the rearview mirror is always clearer than the windshield.", author: "Warren Buffett" },
    { text: "An accountant is someone who solves a problem you didn't know you had in a way you don't understand.", author: "Anonymous" },
    { text: "Behind every good business is a great accountant.", author: "Anonymous" },
    { text: "The hardest thing in the world to understand is the income tax.", author: "Albert Einstein" },
    { text: "The best way to predict the future is to create it.", author: "Peter Drucker" }
    // ... add other quotes if desired
];


// --- AUTHENTICATION ---
document.getElementById('loginForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;

    const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });

    if (error) {
        alert('Login failed: ' + error.message);
    }
    // onAuthStateChange will handle successful login
});

document.getElementById('logoutBtn').addEventListener('click', async () => {
    await supabaseClient.auth.signOut();
    // onAuthStateChange handles logout, but we can force a reload to clear all state
    window.location.reload();
});

supabaseClient.auth.onAuthStateChange(async (event, session) => {
    // If a session exists, check for the user's profile and initialize the app
    if (session && session.user) {
        await initializeUser(session.user);
    } 
    // If the user is signed out, show the login screen
    else {
        document.getElementById('dashboard').classList.add('hidden');
        document.getElementById('loginScreen').classList.remove('hidden');
        currentUser = null;
    }
});


// --- INITIALIZATION ---
async function initializeUser(user) {
    const { data: profile, error } = await supabaseClient
        .from('profiles')
        .select('*')
        .eq('id', user.id)
        .single();

    if (error || !profile) {
        console.error('Error fetching user profile:', error);
        alert('Could not load your profile. Please contact support.');
        await supabaseClient.auth.signOut();
        return;
    }

    currentUser = profile;
    currentUser.email = user.email; // Add email from auth user
    
    showDashboard();
    await loadAllData();
    setupRealtimeSubscriptions();
}

async function loadAllData() {
    // Fetch all users/profiles
    const { data: profilesData } = await supabaseClient.from('profiles').select('*');
    allUsers = profilesData || [];

    // Fetch projects
    const { data: projectsData } = await supabaseClient.from('projects').select('*');
    projects = projectsData || [];
    
    // Fetch tasks
    const { data: tasksData } = await supabaseClient.from('tasks').select('*');
    tasks = tasksData || [];

    // Fetch messages
    const { data: messagesData } = await supabaseClient.from('messages').select('*').or(`sender_id.eq.${currentUser.id},receiver_id.eq.${currentUser.id}`);
    messages = messagesData || [];
    
    // Fetch notifications
    const { data: notificationsData } = await supabaseClient.from('notifications').select('*').eq('user_id', currentUser.id);
    notifications = notificationsData || [];
    
    // Initial render of all components
    renderAllComponents();
}

function renderAllComponents() {
    renderDashboardCards();
    renderProjects();
    renderTasks();
    if(currentUser.role === 'admin') renderUsers();
    renderChatUsers();
    updateNotificationBadge();
}

// --- REAL-TIME SUBSCRIPTIONS ---
function setupRealtimeSubscriptions() {
    const handleDbChange = (payload, localArray, key = 'id') => {
        if (payload.eventType === 'INSERT') {
            localArray.push(payload.new);
        }
        if (payload.eventType === 'UPDATE') {
            const index = localArray.findIndex(item => item[key] === payload.new[key]);
            if (index > -1) localArray[index] = payload.new;
        }
        if (payload.eventType === 'DELETE') {
            const index = localArray.findIndex(item => item[key] === payload.old[key]);
            if (index > -1) localArray.splice(index, 1);
        }
    };

    supabaseClient.channel('public:tasks')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'tasks' }, payload => {
            handleDbChange(payload, tasks);
            renderDashboardCards();
            renderTasks();
            renderProjects();
        }).subscribe();

    supabaseClient.channel('public:projects')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'projects' }, payload => {
            handleDbChange(payload, projects);
            renderProjects();
        }).subscribe();

    supabaseClient.channel('public:messages')
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages', filter: `receiver_id=eq.${currentUser.id}` }, payload => {
            messages.push(payload.new);
            renderChatUsers();
            if (selectedChatUser && selectedChatUser.id === payload.new.sender_id) {
                renderChatMessages();
            }
            const sender = allUsers.find(u => u.id === payload.new.sender_id);
            createNotification(currentUser.id, 'new_message', `New message from ${sender?.name || '...'}`, null, payload.new.id);
        }).subscribe();

     supabaseClient.channel('public:notifications')
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'notifications', filter: `user_id=eq.${currentUser.id}` }, payload => {
            notifications.push(payload.new);
            updateNotificationBadge();
        }).subscribe();
}

// --- UI & RENDERING (Functions from original file, adapted for Supabase) ---

function getInitials(name) {
    if (!name) return '??';
    return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
}

function showDashboard() {
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('dashboard').classList.remove('hidden');
    
    updateAllProfileDisplays();
    
    if (currentUser.role === 'admin' || currentUser.role === 'manager') {
        document.getElementById('adminNav').classList.remove('hidden');
        document.getElementById('addTaskBtn').classList.remove('hidden');
        document.getElementById('addProjectBtn').classList.remove('hidden');
    } else {
        document.getElementById('adminNav').classList.add('hidden');
        document.getElementById('addTaskBtn').classList.add('hidden');
        document.getElementById('addProjectBtn').classList.add('hidden');
    }
    
    updateProfileForm();
    updateQuoteDisplay();
    showSection('dashboard');
}

function updateAllProfileDisplays() {
    document.getElementById('dropdownUserName').textContent = currentUser.name;
    document.getElementById('dropdownUserRole').textContent = currentUser.role;
    document.getElementById('sidebarUserName').textContent = currentUser.name;
    document.getElementById('sidebarUserRole').textContent = currentUser.role;
    updateProfilePictureDisplay();
}

function updateProfilePictureDisplay() {
    const avatars = document.querySelectorAll('#profileAvatar, #sidebarAvatar, #headerProfileBtn');
    const initials = getInitials(currentUser.name);
    
    avatars.forEach(avatar => {
        const span = avatar.querySelector('span');
        if (currentUser.profile_picture_url) {
            avatar.style.backgroundImage = `url(${currentUser.profile_picture_url})`;
            avatar.style.backgroundSize = 'cover';
            avatar.style.backgroundPosition = 'center';
            if(span) span.innerHTML = '';
        } else {
            avatar.style.backgroundImage = '';
            if(span) span.innerHTML = initials;
        }
    });
}

document.getElementById('sidebarToggle').addEventListener('click', function() {
    const sidebar = document.getElementById('sidebar');
    sidebarCollapsed = !sidebarCollapsed;
    sidebar.classList.toggle('sidebar-collapsed', sidebarCollapsed);
});

document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const section = this.dataset.section;
        showSection(section);
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('bg-blue-600', 'text-white'));
        this.classList.add('bg-blue-600', 'text-white');
    });
});

function showSection(sectionName) {
    document.querySelectorAll('.section').forEach(section => section.classList.add('hidden'));
    document.getElementById(sectionName + 'Section').classList.remove('hidden');
    
    if (sectionName === 'tasks') renderTasks();
    else if (sectionName === 'projects') renderProjects();
    else if (sectionName === 'admin') renderUsers();
    else if (sectionName === 'dashboard') renderDashboardCards();
    else if (sectionName === 'chat') renderChatUsers();
}

function renderDashboardCards() {
    const counts = tasks.reduce((acc, task) => {
        acc[task.status] = (acc[task.status] || 0) + 1;
        return acc;
    }, {});

    const cardData = [
        { title: 'To Do', status: 'todo', color: 'orange', icon: 'clipboard' },
        { title: 'On Going', status: 'ongoing', color: 'blue', icon: 'clock' },
        { title: 'Completed', status: 'completed', color: 'green', icon: 'check' },
        { title: 'Data Pending', status: 'data-pending', color: 'yellow', icon: 'exclamation' },
        { title: 'Delayed', status: 'delayed', color: 'red', icon: 'warning' },
        { title: 'Blocked', status: 'blocked', color: 'gray', icon: 'pause' },
        { title: 'Under Review', status: 'review', color: 'indigo', icon: 'check-circle' }
    ];
    
    // Icon paths (unchanged)
    const iconsMap = {
        clipboard: 'M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2', clock: 'M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z', check: 'M5 13l4 4L19 7', 'check-circle': 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z', exclamation: 'M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.34 16.5c-.77.833.192 2.5 1.732 2.5z', warning: 'M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.34 16.5c-.77.833.192 2.5 1.732 2.5z', pause: 'M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z'
    };

    const container = document.getElementById('dashboardTaskCards');
    container.innerHTML = cardData.map(card => `
        <div class="task-card rounded-lg p-4 shadow-sm hover-scale cursor-pointer" onclick="showTaskDetails('${card.status}')">
            <div class="flex flex-col items-center text-center">
                <div class="w-10 h-10 bg-${card.color}-100 rounded-full flex items-center justify-center mb-2">
                    <svg class="w-5 h-5 text-${card.color}-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${iconsMap[card.icon]}"></path></svg>
                </div>
                <h3 class="text-sm font-medium text-gray-800 mb-1">${card.title}</h3>
                <p class="text-2xl font-bold text-${card.color}-600 mb-1">${counts[card.status] || 0}</p>
                <p class="text-xs text-gray-500">tasks</p>
            </div>
        </div>`).join('');
}

function renderTasks() {
    const container = document.getElementById('tasksList');
    let filteredTasks = tasks;
    if (currentUser.role !== 'admin' && currentUser.role !== 'manager') {
        filteredTasks = tasks.filter(t => t.assignee === currentUser.id);
    }
    
    // ... filtering logic from original file would go here ...
    
    if(filteredTasks.length === 0) {
        container.innerHTML = `<p class="text-gray-500 text-center">No tasks found.</p>`;
        return;
    }

    container.innerHTML = filteredTasks.map(task => {
        const assignee = allUsers.find(u => u.id === task.assignee);
        const project = projects.find(p => p.id === task.project_id);
        const isOverdue = new Date(task.due_date) < new Date() && task.status !== 'completed';
        const canEdit = currentUser.role === 'admin' || currentUser.role === 'manager' || task.assignee === currentUser.id;

        // Color maps (unchanged)
        const priorityColors = { low: 'bg-green-100 text-green-800', medium: 'bg-yellow-100 text-yellow-800', high: 'bg-red-100 text-red-800' };
        const statusColors = { todo: 'bg-gray-100 text-gray-800', ongoing: 'bg-blue-100 text-blue-800', completed: 'bg-green-100 text-green-800', delayed: 'bg-red-100 text-red-800', 'data-pending': 'bg-yellow-100 text-yellow-800', review: 'bg-purple-100 text-purple-800', blocked: 'bg-orange-100 text-orange-800' };
        
        return `
            <div class="bg-white rounded-lg shadow-sm p-6 border">
                <div class="flex items-start justify-between mb-3">
                    <h3 class="text-lg font-semibold text-gray-800">${task.title}</h3>
                    <div class="flex space-x-2">
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${priorityColors[task.priority]}">${task.priority}</span>
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${statusColors[task.status]}">${task.status}</span>
                    </div>
                </div>
                <p class="text-gray-600 mb-3">${task.description}</p>
                <div class="flex items-center justify-between">
                    <div>
                        <span class="text-sm text-gray-500">Assigned to: ${assignee?.name || 'Unassigned'}</span><br>
                        <span class="text-sm text-blue-600">Project: ${project?.name || 'None'}</span>
                    </div>
                    <span class="text-sm ${isOverdue ? 'text-red-600 font-bold' : 'text-gray-500'}">Due: ${task.due_date}</span>
                </div>
                <div class="border-t mt-4 pt-4 flex items-center justify-between">
                    <div class="flex space-x-2">
                         ${canEdit ? `<button onclick="editTask(${task.id})" class="text-blue-600 hover:text-blue-800 text-sm">Edit</button>` : ''}
                         ${currentUser.role === 'admin' || currentUser.role === 'manager' ? `<button onclick="deleteTask(${task.id})" class="text-red-600 hover:text-red-800 text-sm">Delete</button>` : ''}
                    </div>
                    ${canEdit ? `
                        <select onchange="updateTaskStatus(${task.id}, this.value)" class="px-3 py-1 border rounded text-sm">
                            <option value="todo" ${task.status === 'todo' ? 'selected' : ''}>To Do</option>
                            <option value="ongoing" ${task.status === 'ongoing' ? 'selected' : ''}>Ongoing</option>
                            <option value="completed" ${task.status === 'completed' ? 'selected' : ''}>Completed</option>
                            <option value="review" ${task.status === 'review' ? 'selected' : ''}>Review</option>
                            <option value="delayed" ${task.status === 'delayed' ? 'selected' : ''}>Delayed</option>
                        </select>
                    ` : ''}
                </div>
            </div>`;
    }).join('');
}

// ... All other functions from your script should be included here, adapted as necessary ...
// For example: renderProjects, renderUsers, renderChatUsers, editTask, deleteTask, etc.
// The key is that they should read from the global arrays (tasks, projects, allUsers)
// and use supabaseClient for any modifications.

// --- FULL SET OF REMAINING FUNCTIONS (ADAPTED) ---

function renderProjects() {
    const container = document.getElementById('projectsList');
    // ... implementation similar to renderTasks ...
    container.innerHTML = projects.map(p => {
        const projectTasks = tasks.filter(t => t.project_id === p.id);
        const completed = projectTasks.filter(t => t.status === 'completed').length;
        const progress = projectTasks.length > 0 ? Math.round((completed / projectTasks.length) * 100) : 0;
        return `
        <div class="bg-white rounded-lg shadow-sm border p-6">
            <h3 class="text-xl font-semibold">${p.name}</h3>
            <p class="text-gray-600">${p.description}</p>
            <div class="mt-4">
                <div class="flex justify-between mb-1"><span class="text-sm font-medium">Progress</span><span class="text-sm font-medium">${progress}%</span></div>
                <div class="w-full bg-gray-200 rounded-full h-2.5"><div class="bg-blue-600 h-2.5 rounded-full" style="width: ${progress}%"></div></div>
            </div>
            </div>
        `
    }).join('');
}

function renderUsers() {
    const container = document.getElementById('usersList');
    container.innerHTML = allUsers.map(user => {
         const avatarContent = user.profile_picture_url 
            ? `<img src="${user.profile_picture_url}" class="w-full h-full object-cover">`
            : getInitials(user.name);
        return `
        <tr>
            <td class="px-6 py-4">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white font-semibold text-sm overflow-hidden">
                        ${avatarContent}
                    </div>
                    <div>
                        <div class="text-sm font-medium">${user.name}</div>
                        </div>
                </div>
            </td>
            <td class="px-6 py-4 text-sm">${user.phone || 'N/A'}</td>
            <td class="px-6 py-4"><span class="px-2 py-1 text-xs rounded-full bg-gray-200">${user.role}</span></td>
            <td class="px-6 py-4 text-sm">
                </td>
        </tr>`;
    }).join('');
}


// --- MODALS AND FORMS ---
document.getElementById('taskForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const assigneeId = document.getElementById('taskAssignee').value;
    const taskData = {
        title: document.getElementById('taskTitle').value,
        description: document.getElementById('taskDescription').value,
        project_id: document.getElementById('taskProject').value,
        assignee: assigneeId,
        priority: document.getElementById('taskPriority').value,
        due_date: document.getElementById('taskDueDate').value,
    };
    let error;
    if (window.editingTaskId) {
        ({ error } = await supabaseClient.from('tasks').update(taskData).eq('id', window.editingTaskId));
    } else {
        taskData.status = 'todo';
        taskData.created_by = currentUser.id;
        const { data, error: insertError } = await supabaseClient.from('tasks').insert(taskData).select().single();
        error = insertError;
        if (!error && data.assignee !== currentUser.id) {
            await createNotification(data.assignee, 'task_assigned', `New task: ${data.title}`, data.id);
        }
    }
    if (error) alert(error.message);
    else {
        document.getElementById('taskModal').classList.add('hidden');
        document.getElementById('taskForm').reset();
        window.editingTaskId = null;
    }
});

document.getElementById('projectForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const projectData = {
        name: document.getElementById('projectName').value,
        description: document.getElementById('projectDescription').value,
        start_date: document.getElementById('projectStartDate').value,
        end_date: document.getElementById('projectEndDate').value,
    };
    let error;
    if (window.editingProjectId) {
        ({ error } = await supabaseClient.from('projects').update(projectData).eq('id', window.editingProjectId));
    } else {
        projectData.created_by = currentUser.id;
        ({ error } = await supabaseClient.from('projects').insert(projectData));
    }
    if (error) alert(error.message);
    else {
        document.getElementById('projectModal').classList.add('hidden');
        document.getElementById('projectForm').reset();
        window.editingProjectId = null;
    }
});

document.getElementById('updateProfileBtn').addEventListener('click', async function() {
    const updates = {
        name: document.getElementById('profileName').value,
        phone: document.getElementById('profilePhone').value,
        address: document.getElementById('profileAddress').value,
    };
    const profileFile = document.getElementById('profilePictureFile').files[0];
    if (profileFile) {
        const fileName = `${currentUser.id}/${Date.now()}`;
        const { error: uploadError } = await supabaseClient.storage.from('avatars').upload(fileName, profileFile);
        if (uploadError) {
            return alert(uploadError.message);
        }
        const { data } = supabaseClient.storage.from('avatars').getPublicUrl(fileName);
        updates.profile_picture_url = data.publicUrl;
    }
    const { data, error } = await supabaseClient.from('profiles').update(updates).eq('id', currentUser.id).select().single();
    if (error) alert(error.message);
    else {
        currentUser = {...currentUser, ...data};
        updateAllProfileDisplays();
        updateProfileForm();
        alert('Profile updated!');
    }
});

function editTask(taskId) {
    const task = tasks.find(t => t.id === taskId);
    if (!task) return;
    window.editingTaskId = taskId;
    document.querySelector('#taskModal h3').textContent = 'Edit Task';
    document.querySelector('#taskForm button[type="submit"]').textContent = 'Update Task';
    
    document.getElementById('taskTitle').value = task.title;
    document.getElementById('taskDescription').value = task.description;
    document.getElementById('taskDueDate').value = task.due_date;
    document.getElementById('taskPriority').value = task.priority;
    
    populateAssigneeDropdown(task.assignee);
    populateProjectDropdown(task.project_id);

    document.getElementById('taskModal').classList.remove('hidden');
}

async function deleteTask(taskId) {
    if (confirm('Are you sure?')) {
        const { error } = await supabaseClient.from('tasks').delete().eq('id', taskId);
        if(error) alert(error.message);
    }
}

async function updateTaskStatus(taskId, newStatus) {
    const { error } = await supabaseClient.from('tasks').update({ status: newStatus }).eq('id', taskId);
    if(error) alert(error.message);
}


// --- CHAT FUNCTIONS ---

function renderChatUsers() {
    const container = document.getElementById('chatUsersList');
    container.innerHTML = allUsers.filter(u => u.id !== currentUser.id).map(user => {
        const unread = messages.filter(m => m.sender_id === user.id && m.receiver_id === currentUser.id && !m.read).length;
        const avatarContent = user.profile_picture_url ? `<img src="${user.profile_picture_url}" class="w-full h-full object-cover">` : getInitials(user.name);
        return `
        <div class="p-4 border-b hover:bg-gray-50 cursor-pointer flex items-center space-x-3" onclick="selectChatUser('${user.id}')">
            <div class="relative">
                <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center text-white overflow-hidden">${avatarContent}</div>
                ${unread > 0 ? `<div class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 rounded-full flex items-center justify-center text-xs text-white">${unread}</div>` : ''}
            </div>
            <div class="flex-1 min-w-0"><h4 class="font-medium truncate">${user.name}</h4></div>
        </div>`;
    }).join('');
}

async function selectChatUser(userId) {
    selectedChatUser = allUsers.find(u => u.id === userId);
    if (!selectedChatUser) return;
    
    document.getElementById('chatHeader').classList.remove('hidden');
    document.getElementById('chatInput').classList.remove('hidden');
    document.getElementById('chatUserName').textContent = selectedChatUser.name;
    document.getElementById('chatUserRole').textContent = selectedChatUser.role;

    // Mark messages as read
    const { error } = await supabaseClient.from('messages').update({ read: true }).eq('sender_id', userId).eq('receiver_id', currentUser.id);
    if(!error) {
        messages.forEach(m => { if(m.sender_id === userId && m.receiver_id === currentUser.id) m.read = true; });
    }
    
    renderChatMessages();
    renderChatUsers(); // To remove unread badge
}

function renderChatMessages() {
    if (!selectedChatUser) return;
    const container = document.getElementById('chatMessages');
    const conversation = messages.filter(m => (m.sender_id === currentUser.id && m.receiver_id === selectedChatUser.id) || (m.sender_id === selectedChatUser.id && m.receiver_id === currentUser.id))
        .sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
    
    container.innerHTML = conversation.map(msg => {
        const isMe = msg.sender_id === currentUser.id;
        return `
        <div class="flex ${isMe ? 'justify-end' : 'justify-start'}">
            <div class="max-w-xs lg:max-w-md">
                <div class="${isMe ? 'bg-blue-600 text-white' : 'bg-white'} rounded-lg px-4 py-2 shadow-sm">
                    <p class="text-sm">${msg.content}</p>
                </div>
            </div>
        </div>`;
    }).join('<div class="h-4"></div>');
    container.scrollTop = container.scrollHeight;
}

async function sendMessage() {
    if (!selectedChatUser) return;
    const input = document.getElementById('messageInput');
    const content = input.value.trim();
    if (!content) return;
    
    const msgData = { sender_id: currentUser.id, receiver_id: selectedChatUser.id, content: content };
    
    input.value = ''; // Clear input immediately for better UX
    
    // Optimistically update UI
    messages.push({...msgData, created_at: new Date().toISOString()});
    renderChatMessages();
    
    const { error } = await supabaseClient.from('messages').insert(msgData);
    if(error) {
        alert("Message failed to send.");
        // Optional: remove optimistic message or show error state
    }
}


// --- HELPER & MISC FUNCTIONS ---

function updateProfileForm() {
    document.getElementById('profileName').value = currentUser.name || '';
    document.getElementById('profileEmail').value = currentUser.email || '';
    document.getElementById('profilePhone').value = currentUser.phone || '';
    document.getElementById('profileAddress').value = currentUser.address || '';
    document.getElementById('profileDisplayName').textContent = currentUser.name;
    document.getElementById('profileDisplayRole').textContent = currentUser.role;
    updateProfilePictureDisplay();
}

function getRandomQuote() { return quotes[Math.floor(Math.random() * quotes.length)]; }

function updateQuoteDisplay() {
    const quote = getRandomQuote();
    const quoteBox = document.querySelector('.quote-box .bg-white');
    if (quoteBox) {
        quoteBox.innerHTML = `<p class="text-sm italic">"${quote.text}"</p><p class="text-xs text-right mt-2">– ${quote.author}</p>`;
    }
}

function getTimeAgo(date) {
    const now = new Date();
    const diffInSeconds = Math.floor((now - new Date(date)) / 1000);
    if (diffInSeconds < 60) return 'Just now';
    if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
    if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
    return `${Math.floor(diffInSeconds / 86400)}d ago`;
}

function populateAssigneeDropdown(selectedValue) {
    const select = document.getElementById('taskAssignee');
    select.innerHTML = allUsers.map(user => `<option value="${user.id}" ${selectedValue === user.id ? 'selected' : ''}>${user.name}</option>`).join('');
}

function populateProjectDropdown(selectedValue) {
    const select = document.getElementById('taskProject');
    select.innerHTML = projects.map(p => `<option value="${p.id}" ${selectedValue === p.id ? 'selected' : ''}>${p.name}</option>`).join('');
}

// ... Add any other minor helper functions from your original script ...
// Example: Add Task button click listener
document.getElementById('addTaskBtn').addEventListener('click', () => {
    window.editingTaskId = null;
    document.querySelector('#taskModal h3').textContent = 'Add New Task';
    document.querySelector('#taskForm button[type="submit"]').textContent = 'Create Task';
    document.getElementById('taskForm').reset();
    populateAssigneeDropdown();
    populateProjectDropdown();
    document.getElementById('taskModal').classList.remove('hidden');
});
document.getElementById('cancelTaskBtn').addEventListener('click', () => {
    document.getElementById('taskModal').classList.add('hidden');
});

// Night mode, Refresh page, etc. can be added here if needed.
applyNightMode(); // Apply dark mode on initial load if set

function applyNightMode() {
    if (isDarkMode) {
        document.body.classList.add('dark');
    } else {
        document.body.classList.remove('dark');
    }
}
    </script>
</body>
</html>

